name: CI/CD ACR + AKS (Producer)

on:
  push:
    branches: [ main ]

jobs:
  build-deploy-producer:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v3

      - name: ğŸ” Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: âš™ï¸ Gradle Build - Create JAR
        run: ./gradlew :producer:build

      - name: ğŸ³ ACR Docker Login (CLI ë°©ì‹)
        run: az acr login --name team08registry

      - name: ğŸ³ Docker Build & Push - Producer
        run: |
          IMAGE_TAG=producer-service:${{ github.sha }}
          docker build -t team08registry.azurecr.io/$IMAGE_TAG ./producer
          docker push team08registry.azurecr.io/$IMAGE_TAG
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV

      - name: â˜¸ï¸ Set AKS Context
        uses: azure/aks-set-context@v3
        with:
          resource-group: team08
          cluster-name: team08aks

      - name: ğŸ” Create Kubernetes Secret for DB
        run: |
          kubectl create secret generic producer-db-secret \
            --from-literal=DB_URL="${{ secrets.DB_URL }}" \
            --from-literal=DB_USERNAME="${{ secrets.DB_USERNAME }}" \
            --from-literal=DB_PASSWORD="${{ secrets.DB_PASSWORD }}" \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: ğŸ” Create Kubernetes Secret for Kafka
        run: |
          kubectl create secret generic producer-kafka-secret \
            --from-literal=CONNECTION_STRING="${{ secrets.KAFKA_CONNECTION_STRING }}" \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: ğŸ§± Apply IngressClass first
        run: kubectl apply -f ./k8s/ingress-class.yaml

      - name: ğŸš€ Apply Deployment & Service
        run: |
          kubectl apply -f ./k8s/producer-deployment.yaml

      - name: ğŸšª Delete & Reapply Ingress (ensure update)
        run: |
          kubectl delete ingress main-ingress --ignore-not-found
          kubectl apply -f ./k8s/ingress.yaml

      - name: ğŸ”„ Update Deployment Image âœ…
        run: |
          kubectl set image deployment/producer-deployment producer=team08registry.azurecr.io/$IMAGE_TAG

      - name: ğŸ§¹ Delete old ReplicaSets (DESIRED=0)
        run: |
          kubectl get rs \
            --selector=app=producer \
            --no-headers \
            | awk '$2==0 && $3==0 && $4==0 {print $1}' \
            | xargs -r kubectl delete rs
