name: CI/CD ACR + AKS (Producer)

on:
  push:
    branches: [ main ]

jobs:
  build-deploy-producer:
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v3

      - name: 🔐 Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ⚙️ Gradle Build - Create JAR
        run: ./gradlew :producer:build

      - name: 🐳 ACR Docker Login (CLI 방식)
        run: az acr login --name team08registry

      - name: 🐳 Docker Build & Push - Producer
        run: |
          docker build -t team08registry.azurecr.io/producer-service:v1 ./producer
          docker push team08registry.azurecr.io/producer-service:v1

      - name: ☸️ Set AKS Context
        uses: azure/aks-set-context@v3
        with:
          resource-group: team08
          cluster-name: team08aks

      - name: 🔐 Create Kubernetes Secret for DB
        run: |
          kubectl create secret generic producer-db-secret \
            --from-literal=DB_URL="${{ secrets.DB_URL }}" \
            --from-literal=DB_USERNAME="${{ secrets.DB_USERNAME }}" \
            --from-literal=DB_PASSWORD="${{ secrets.DB_PASSWORD }}" \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: 🚀 Deploy All Services + Ingress
        run: |
          kubectl apply -f ./k8s/

